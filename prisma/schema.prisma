// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String     @id @default(cuid())
  email     String     @unique
  password  String
  name      String
  role      String     @default("user") // "admin" o "user"
  active    Boolean    @default(true)
  avatar    String?    // URL o base64 de la foto de perfil
  emailVerified Boolean  @default(false) // Si el email ha sido verificado
  verificationCode String? // Código de verificación de 6 dígitos
  verificationCodeExpiry DateTime? // Expiración del código
  
  // Usuario que lo creó (null si es el usuario principal registrado)
  createdById String?
  createdBy   User?    @relation("UserCreator", fields: [createdById], references: [id], onDelete: Cascade)
  
  // Usuarios que este usuario ha creado
  createdUsers User[] @relation("UserCreator")
  
  // Empresa asignada por defecto
  defaultCompanyId String?
  defaultCompany   Company? @relation("DefaultCompany", fields: [defaultCompanyId], references: [id], onDelete: SetNull)
  
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  
  companies Company[]
  contacts  Contact[]
  products  Product[]
  invoices  Invoice[]
  attendances Attendance[]
  projects  Project[]
  tasks     Task[]
}

model Company {
  id        String     @id @default(cuid())
  userId    String
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name      String
  nif       String?    // NIF/CIF de la empresa
  address   String?
  city      String?
  postalCode String?
  country   String?    // País de la empresa
  phone     String?
  email     String?
  logo      String?    // URL del logo de la empresa
  
  // Colores del tema
  primaryColor   String    @default("#10b981")  // Color principal (verde por defecto)
  secondaryColor String    @default("#059669")  // Color secundario
  
  // Moneda
  currency       String    @default("EUR")      // Moneda por defecto (EUR, USD, etc.)
  
  // Secuencias de facturas
  salesInvoicePrefix     String    @default("INV")   // Prefijo para facturas de venta
  salesInvoiceNextNumber Int       @default(1)       // Próximo número de factura de venta
  purchaseInvoicePrefix  String    @default("INVO")  // Prefijo para facturas de compra
  purchaseInvoiceNextNumber Int    @default(1)       // Próximo número de factura de compra
  
  // Configuración SMTP para envío de correos
  smtpHost     String?  // smtp.gmail.com
  smtpPort     Int?     // 587
  smtpUser     String?  // correo@gmail.com
  smtpPassword String?  // Contraseña de aplicación de Gmail
  emailTemplate String? @db.Text  // Plantilla HTML personalizada para emails de facturas
  
  // Configuración de API
  apiEnabled   Boolean  @default(false)  // Si la API está habilitada para esta empresa
  apiKey       String?  @unique          // Clave de API única para autenticación
  
  // Token para subida pública de facturas de compra
  uploadToken  String?  @unique          // Token único para subir facturas desde URL pública
  uploadTokenEnabled Boolean @default(false)  // Si el token de subida está habilitado
  
  // Configuración de Odoo JSON-RPC
  odooUrl      String?  // URL de Odoo (ej: https://demo.odoo.com)
  odooDb       String?  // Nombre de la base de datos de Odoo
  odooUsername String?  // Usuario de Odoo
  odooPassword String?  // Contraseña o API Key de Odoo
  odooVersion  String?  @default("17")  // Versión de Odoo (1-19)
  odooPort     String?  @default("8069")  // Puerto de conexión a Odoo
  odooEnabled  Boolean  @default(false)  // Si la integración con Odoo está habilitada
  // odooCreateInvoiceOnSale Boolean @default(false)  // Crear factura en Odoo automáticamente desde POS // TODO: Descomentar y ejecutar migración
  
  active    Boolean    @default(false)  // Solo una empresa puede estar activa a la vez
  
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  
  contacts  Contact[]
  products  Product[]
  invoices  Invoice[]
  attendances Attendance[]
  projects  Project[]
  defaultUsers User[] @relation("DefaultCompany")
  crmPipelines CrmPipeline[]
  crmOpportunities CrmOpportunity[]
  
  @@index([userId])
  @@index([userId, active])
}

model Contact {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  companyId   String
  company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  // Datos del contacto
  name        String
  nif         String?   // NIF/CIF del contacto
  email       String?
  phone       String?
  address     String?
  city        String?
  postalCode  String?
  country     String?   @default("España")
  
  // Tipo de contacto
  isCustomer  Boolean   @default(true)  // Es cliente
  isSupplier  Boolean   @default(true)  // Es proveedor
  
  // Estado
  active      Boolean   @default(true)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  invoices    Invoice[]
  crmOpportunities CrmOpportunity[]
  
  @@index([userId])
  @@index([companyId])
  @@index([email])
}

model Product {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  companyId   String
  company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  // Datos del producto
  code        String    // Código del producto
  name        String
  description String?
  image       String?   // URL de la imagen del producto
  type        String    @default("storable") // "storable" (almacenable) o "service" (servicio)
  
  // Precios
  price       Float     // Precio unitario sin IVA
  tax         Float     @default(21) // Porcentaje de IVA
  
  // Inventario (solo para productos almacenables)
  stock       Int       @default(0)
  minStock    Int?      // Stock mínimo para alertas
  
  // Categorización
  category    String?
  unit        String    @default("unidad") // unidad, kg, litro, etc.
  
  // Estado
  active      Boolean   @default(true)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  invoiceItems InvoiceItem[]
  
  @@unique([companyId, code])
  @@index([userId])
  @@index([companyId])
  @@index([type])
}

model Invoice {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  companyId     String
  company       Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  contactId     String
  contact       Contact   @relation(fields: [contactId], references: [id], onDelete: Cascade)
  
  // Tipo de factura
  type          InvoiceType @default(SALE) // Venta o Compra
  
  // Número de factura
  number        String    // Número de factura (ej: INV-2024-001)
  
  // Referencia del proveedor (solo para facturas de compra)
  supplierReference String?
  
  // Fechas
  date          DateTime  @default(now())
  dueDate       DateTime?
  
  // Moneda
  currency      String    @default("EUR") // Moneda de la factura
  
  // Importes
  subtotal      Float     // Suma de items sin IVA
  taxAmount     Float     // Total de IVA
  total         Float     // Total con IVA
  
  // Estado de validación
  status        InvoiceStatus @default(DRAFT)
  
  // Estado de pago
  paymentStatus PaymentStatus @default(UNPAID)
  
  // Notas
  notes         String?
  
  // Token público para descarga sin autenticación
  publicToken   String?   @unique  // Token único para acceso público al PDF
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  items         InvoiceItem[]
  attachments   InvoiceAttachment[]
  comments      InvoiceComment[]
  
  @@unique([companyId, number])
  @@index([userId])
  @@index([companyId])
  @@index([contactId])
}

enum InvoiceType {
  SALE        // Factura de venta
  PURCHASE    // Factura de compra
}

enum InvoiceStatus {
  DRAFT       // Borrador
  VALIDATED   // Validada
}

enum PaymentStatus {
  UNPAID      // Sin pagar
  PAID        // Pagada
}

model InvoiceItem {
  id          String   @id @default(cuid())
  invoiceId   String
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  productId   String?
  product     Product? @relation(fields: [productId], references: [id])
  
  // Datos del item
  description String
  quantity    Float
  price       Float    // Precio unitario sin IVA
  tax         Float    // Porcentaje de IVA
  
  // Calculados
  subtotal    Float    // quantity * price
  taxAmount   Float    // subtotal * (tax / 100)
  total       Float    // subtotal + taxAmount
  
  createdAt   DateTime @default(now())
  
  @@index([invoiceId])
  @@index([productId])
}

model InvoiceAttachment {
  id          String   @id @default(cuid())
  invoiceId   String
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  fileName    String   // Nombre original del archivo
  fileUrl     String   // URL o path del archivo
  fileSize    Int      // Tamaño en bytes
  mimeType    String   // Tipo MIME (application/pdf, image/jpeg, etc.)
  
  createdAt   DateTime @default(now())
  
  @@index([invoiceId])
}

model InvoiceComment {
  id          String   @id @default(cuid())
  invoiceId   String
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  userId      String
  userName    String   // Nombre del usuario que creó el comentario
  
  comment     String   // Contenido del comentario
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([invoiceId])
  @@index([createdAt])
}

model Attendance {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  date        DateTime @default(now())
  checkIn     DateTime @default(now())
  checkOut    DateTime?
  
  notes       String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([userId])
  @@index([companyId])
  @@index([date])
}

model Backup {
  id          String   @id @default(cuid())
  name        String   // Nombre descriptivo del respaldo
  data        String   @db.Text // JSON del respaldo
  size        Int      // Tamaño en bytes
  createdBy   String   // ID del usuario que creó el respaldo
  createdAt   DateTime @default(now())
  
  @@index([createdAt])
}

model Project {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  name        String
  description String?  @db.Text
  status      ProjectStatus @default(ACTIVE)
  
  startDate   DateTime?
  endDate     DateTime?
  
  color       String?  @default("#10b981") // Color para identificación visual
  
  active      Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  tasks       Task[]
  
  @@index([userId])
  @@index([companyId])
  @@index([status])
}

enum ProjectStatus {
  ACTIVE      // Activo
  COMPLETED   // Completado
  ARCHIVED    // Archivado
}

model Task {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  title       String
  description String?  @db.Text
  completed   Boolean  @default(false)
  
  priority    TaskPriority @default(MEDIUM)
  
  dueDate     DateTime?
  completedAt DateTime?
  
  order       Int      @default(0) // Para ordenar tareas
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([userId])
  @@index([projectId])
  @@index([completed])
}

enum TaskPriority {
  LOW         // Baja
  MEDIUM      // Media
  HIGH        // Alta
  URGENT      // Urgente
}

model WebContact {
  id          String   @id @default(cuid())
  name        String
  email       String
  phone       String?
  company     String?
  message     String   @db.Text
  status      WebContactStatus @default(PENDING)
  notes       String?  @db.Text
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([status])
  @@index([createdAt])
}

enum WebContactStatus {
  PENDING     // Pendiente
  CONTACTED   // Contactado
  CLOSED      // Cerrado
}

// Modelos CRM
model CrmPipeline {
  id          String   @id @default(cuid())
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  name        String   // Nombre del pipeline (ej: "Ventas", "Proyectos")
  description String?  @db.Text
  isDefault   Boolean  @default(false)
  order       Int      @default(0)
  
  publicFormToken String? @unique // Token único para formulario público de oportunidades
  publicFormEnabled Boolean @default(false) // Si el formulario público está habilitado
  
  stages      CrmStage[]
  opportunities CrmOpportunity[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([companyId])
}

model CrmStage {
  id          String   @id @default(cuid())
  pipelineId  String
  pipeline    CrmPipeline @relation(fields: [pipelineId], references: [id], onDelete: Cascade)
  
  name        String   // Nombre de la etapa (ej: "Prospecto", "Negociación", "Cerrado")
  color       String   @default("#3b82f6") // Color de la etapa
  order       Int      @default(0) // Orden de la etapa en el pipeline
  
  opportunities CrmOpportunity[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([pipelineId])
}

model CrmOpportunity {
  id          String   @id @default(cuid())
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  pipelineId  String
  pipeline    CrmPipeline @relation(fields: [pipelineId], references: [id], onDelete: Cascade)
  
  stageId     String
  stage       CrmStage @relation(fields: [stageId], references: [id], onDelete: Restrict)
  
  contactId   String?
  contact     Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)
  
  title       String   // Título de la oportunidad
  description String?  @db.Text
  value       Float    @default(0) // Valor estimado de la oportunidad
  currency    String   @default("EUR")
  probability Int      @default(50) // Probabilidad de cierre (0-100)
  
  expectedCloseDate DateTime?
  closedDate        DateTime?
  
  priority    OpportunityPriority @default(MEDIUM)
  status      OpportunityStatus   @default(OPEN)
  
  tags        String[] // Tags para categorizar (ej: ["urgente", "grande"])
  
  scheduledDate DateTime? // Fecha programada para seguimiento en calendario
  
  order       Int      @default(0) // Orden dentro de la etapa
  
  notes       String?  @db.Text
  
  activities  CrmActivity[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([companyId])
  @@index([pipelineId])
  @@index([stageId])
  @@index([contactId])
  @@index([status])
}

enum OpportunityPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum OpportunityStatus {
  OPEN        // Abierta
  WON         // Ganada
  LOST        // Perdida
}

model CrmActivity {
  id            String   @id @default(cuid())
  opportunityId String
  opportunity   CrmOpportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  
  type          ActivityType
  title         String
  description   String?  @db.Text
  dueDate       DateTime?
  completed     Boolean  @default(false)
  completedAt   DateTime?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([opportunityId])
  @@index([completed])
}

enum ActivityType {
  CALL        // Llamada
  EMAIL       // Email
  MEETING     // Reunión
  TASK        // Tarea
  NOTE        // Nota
}
