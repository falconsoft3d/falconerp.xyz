// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String     @id @default(cuid())
  email     String     @unique
  password  String
  name      String
  role      String     @default("user") // "admin" o "user"
  active    Boolean    @default(true)
  avatar    String?    // URL o base64 de la foto de perfil
  emailVerified Boolean  @default(false) // Si el email ha sido verificado
  verificationCode String? // Código de verificación de 6 dígitos
  verificationCodeExpiry DateTime? // Expiración del código
  
  // Token para registro de asistencia desde móvil
  attendanceToken String? @unique // Token único para acceder desde móvil
  
  // Coste por hora para cálculo de asistencia
  hourlyRate Decimal? @db.Decimal(10, 2) // Coste por hora del empleado
  
  // Usuario que lo creó (null si es el usuario principal registrado)
  createdById String?
  createdBy   User?    @relation("UserCreator", fields: [createdById], references: [id], onDelete: Cascade)
  
  // Usuarios que este usuario ha creado
  createdUsers User[] @relation("UserCreator")
  
  // Empresa asignada por defecto
  defaultCompanyId String?
  defaultCompany   Company? @relation("DefaultCompany", fields: [defaultCompanyId], references: [id], onDelete: SetNull)
  
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  
  companies Company[]
  contacts  Contact[]
  products  Product[]
  invoices  Invoice[]
  quotes    Quote[]
  attendances Attendance[]
  projects  Project[]
  tasks     Task[] @relation("TaskCreator")
  assignedTasks Task[] @relation("TaskAssignee")
  trackings Tracking[]
  projectStaff ProjectStaff[]
  equipment Equipment[]
  workOrders WorkOrder[]
  responsibleWorkOrders WorkOrder[] @relation("WorkOrderResponsible")
  properties Property[]
}

model Company {
  id        String     @id @default(cuid())
  userId    String
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name      String
  nif       String?    // NIF/CIF de la empresa
  address   String?
  city      String?
  postalCode String?
  country   String?    // País de la empresa
  phone     String?
  email     String?
  logo      String?    // URL del logo de la empresa
  
  // Colores del tema
  primaryColor   String    @default("#10b981")  // Color principal (verde por defecto)
  secondaryColor String    @default("#059669")  // Color secundario
  
  // Moneda
  currency       String    @default("EUR")      // Moneda por defecto (EUR, USD, etc.)
  
  // Secuencias de facturas
  salesInvoicePrefix     String    @default("INV")   // Prefijo para facturas de venta
  salesInvoiceNextNumber Int       @default(1)       // Próximo número de factura de venta
  purchaseInvoicePrefix  String    @default("INVO")  // Prefijo para facturas de compra
  purchaseInvoiceNextNumber Int    @default(1)       // Próximo número de factura de compra
  
  // Secuencias de cotizaciones
  quotePrefix            String    @default("COT")   // Prefijo para cotizaciones
  quoteNextNumber        Int       @default(1)       // Próximo número de cotización
  
  // Configuración SMTP para envío de correos
  smtpHost     String?  // smtp.gmail.com
  smtpPort     Int?     // 587
  smtpUser     String?  // correo@gmail.com
  smtpPassword String?  // Contraseña de aplicación de Gmail
  emailTemplate String? @db.Text  // Plantilla HTML personalizada para emails de facturas
  
  // Configuración de API
  apiEnabled   Boolean  @default(false)  // Si la API está habilitada para esta empresa
  apiKey       String?  @unique          // Clave de API única para autenticación
  
  // Token para subida pública de facturas de compra
  uploadToken  String?  @unique          // Token único para subir facturas desde URL pública
  uploadTokenEnabled Boolean @default(false)  // Si el token de subida está habilitado
  
  // Configuración de Odoo JSON-RPC
  odooUrl      String?  // URL de Odoo (ej: https://demo.odoo.com)
  odooDb       String?  // Nombre de la base de datos de Odoo
  odooUsername String?  // Usuario de Odoo
  odooPassword String?  // Contraseña o API Key de Odoo
  odooVersion  String?  @default("17")  // Versión de Odoo (1-19)
  odooPort     String?  @default("8069")  // Puerto de conexión a Odoo
  odooEnabled  Boolean  @default(false)  // Si la integración con Odoo está habilitada
  // odooCreateInvoiceOnSale Boolean @default(false)  // Crear factura en Odoo automáticamente desde POS // TODO: Descomentar y ejecutar migración
  
  active    Boolean    @default(false)  // Solo una empresa puede estar activa a la vez
  
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  
  contacts  Contact[]
  products  Product[]
  invoices  Invoice[]
  quotes    Quote[]
  attendances Attendance[]
  projects  Project[]
  equipment Equipment[]
  defaultUsers User[] @relation("DefaultCompany")
  crmPipelines CrmPipeline[]
  crmOpportunities CrmOpportunity[]
  trackings Tracking[]
  workOrders WorkOrder[]
  properties Property[]
  
  @@index([userId])
  @@index([userId, active])
}

model Contact {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  companyId   String
  company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  // Datos del contacto
  name        String
  nif         String?   // NIF/CIF del contacto
  email       String?
  phone       String?
  address     String?
  city        String?
  postalCode  String?
  country     String?   @default("España")
  
  // Tipo de contacto
  isCustomer  Boolean   @default(true)  // Es cliente
  isSupplier  Boolean   @default(true)  // Es proveedor
  
  // Estado
  active      Boolean   @default(true)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  invoices    Invoice[]
  quotes      Quote[]
  crmOpportunities CrmOpportunity[]
  trackings   Tracking[]
  equipment   Equipment[]
  propertyContacts PropertyContact[]
  
  @@index([userId])
  @@index([companyId])
  @@index([email])
}

model Product {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  companyId   String
  company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  // Datos del producto
  code        String    // Código del producto
  name        String
  description String?
  image       String?   // URL de la imagen del producto
  type        String    @default("storable") // "storable" (almacenable) o "service" (servicio)
  
  // Precios
  price       Float     // Precio unitario sin IVA
  tax         Float     @default(21) // Porcentaje de IVA
  
  // Inventario (solo para productos almacenables)
  stock       Int       @default(0)
  minStock    Int?      // Stock mínimo para alertas
  
  // Categorización
  category    String?
  unit        String    @default("unidad") // unidad, kg, litro, etc.
  
  // Estado
  active      Boolean   @default(true)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  invoiceItems InvoiceItem[]
  quoteItems   QuoteItem[]
  trackings    Tracking[]
  projects     Project[]
  workOrderItems WorkOrderItem[]
  
  @@unique([companyId, code])
  @@index([userId])
  @@index([companyId])
  @@index([type])
}

model Invoice {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  companyId     String
  company       Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  contactId     String
  contact       Contact   @relation(fields: [contactId], references: [id], onDelete: Cascade)
  
  // Tipo de factura
  type          InvoiceType @default(SALE) // Venta o Compra
  
  // Número de factura
  number        String    // Número de factura (ej: INV-2024-001)
  
  // Referencia del proveedor (solo para facturas de compra)
  supplierReference String?
  
  // Fechas
  date          DateTime  @default(now())
  dueDate       DateTime?
  
  // Moneda
  currency      String    @default("EUR") // Moneda de la factura
  
  // Importes
  subtotal      Float     // Suma de items sin IVA
  taxAmount     Float     // Total de IVA
  total         Float     // Total con IVA
  
  // Estado de validación
  status        InvoiceStatus @default(DRAFT)
  
  // Estado de pago
  paymentStatus PaymentStatus @default(UNPAID)
  
  // Notas
  notes         String?
  
  // Token público para descarga sin autenticación
  publicToken   String?   @unique  // Token único para acceso público al PDF
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  items         InvoiceItem[]
  attachments   InvoiceAttachment[]
  comments      InvoiceComment[]
  trackings     Tracking[]
  quoteInvoice  Quote?        @relation("QuoteToInvoice")
  
  @@unique([companyId, number])
  @@index([userId])
  @@index([companyId])
  @@index([contactId])
}

enum InvoiceType {
  SALE        // Factura de venta
  PURCHASE    // Factura de compra
}

enum InvoiceStatus {
  DRAFT       // Borrador
  VALIDATED   // Validada
}

enum PaymentStatus {
  UNPAID      // Sin pagar
  PAID        // Pagada
}

model InvoiceItem {
  id          String   @id @default(cuid())
  invoiceId   String
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  productId   String?
  product     Product? @relation(fields: [productId], references: [id])
  
  projectId   String?
  project     Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  
  // Datos del item
  description String
  quantity    Float
  price       Float    // Precio unitario sin IVA
  tax         Float    // Porcentaje de IVA
  
  // Calculados
  subtotal    Float    // quantity * price
  taxAmount   Float    // subtotal * (tax / 100)
  total       Float    // subtotal + taxAmount
  
  createdAt   DateTime @default(now())
  
  @@index([invoiceId])
  @@index([productId])
  @@index([projectId])
}

model InvoiceAttachment {
  id          String   @id @default(cuid())
  invoiceId   String
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  fileName    String   // Nombre original del archivo
  fileUrl     String   // URL o path del archivo
  fileSize    Int      // Tamaño en bytes
  mimeType    String   // Tipo MIME (application/pdf, image/jpeg, etc.)
  
  createdAt   DateTime @default(now())
  
  @@index([invoiceId])
}

model Quote {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  companyId     String
  company       Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  contactId     String
  contact       Contact   @relation(fields: [contactId], references: [id], onDelete: Cascade)
  
  // Número de cotización
  number        String    // Número de cotización (ej: COT-2024-001)
  
  // Fechas
  date          DateTime  @default(now())
  expiryDate    DateTime? // Fecha de expiración de la cotización
  
  // Moneda
  currency      String    @default("EUR") // Moneda de la cotización
  
  // Importes
  subtotal      Float     // Suma de items sin IVA
  taxAmount     Float     // Total de IVA
  total         Float     // Total con IVA
  
  // Estado de la cotización
  status        QuoteStatus @default(QUOTE) // QUOTE o ORDER
  
  // Notas
  notes         String?
  
  // Relación con factura generada
  invoiceId     String?   @unique
  invoice       Invoice?  @relation("QuoteToInvoice", fields: [invoiceId], references: [id], onDelete: SetNull)
  
  // Relación con orden de trabajo generada
  workOrderId   String?   @unique
  workOrder     WorkOrder? @relation("QuoteToWorkOrder", fields: [workOrderId], references: [id], onDelete: SetNull)
  
  // Token público para descarga sin autenticación
  publicToken   String?   @unique  // Token único para acceso público al PDF
  
  // Aprobación del cliente
  clientApprovalStatus  QuoteClientApproval @default(PENDING)
  clientApprovedAt      DateTime?
  clientRejectionReason String?
  
  // Archivos adjuntos y comentarios
  attachments   QuoteAttachment[]
  comments      QuoteComment[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  items         QuoteItem[]
  
  @@unique([companyId, number])
  @@index([userId])
  @@index([companyId])
  @@index([contactId])
  @@index([status])
  @@index([date])
  @@index([publicToken])
  @@index([clientApprovalStatus])
}

enum QuoteStatus {
  QUOTE       // Cotización
  ORDER       // Pedido (confirmada)
}

enum QuoteClientApproval {
  PENDING     // Pendiente de aprobación
  APPROVED    // Aprobado por el cliente
  REJECTED    // Rechazado por el cliente
}

model QuoteItem {
  id          String   @id @default(cuid())
  quoteId     String
  quote       Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  
  productId   String?
  product     Product? @relation(fields: [productId], references: [id])
  
  projectId   String?
  project     Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  
  // Datos del item
  description String
  quantity    Float
  price       Float    // Precio unitario sin IVA
  tax         Float    // Porcentaje de IVA
  
  // Calculados
  subtotal    Float    // quantity * price
  taxAmount   Float    // subtotal * (tax / 100)
  total       Float    // subtotal + taxAmount
  
  createdAt   DateTime @default(now())
  
  @@index([quoteId])
  @@index([productId])
  @@index([projectId])
}

model QuoteAttachment {
  id          String   @id @default(cuid())
  quoteId     String
  quote       Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  
  fileName    String   // Nombre original del archivo
  fileUrl     String   // URL o path del archivo
  fileSize    Int      // Tamaño en bytes
  mimeType    String   // Tipo MIME (application/pdf, image/jpeg, etc.)
  
  createdAt   DateTime @default(now())
  
  @@index([quoteId])
}

model QuoteComment {
  id          String   @id @default(cuid())
  quoteId     String
  quote       Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  
  comment     String   @db.Text
  
  createdAt   DateTime @default(now())
  
  @@index([quoteId])
}

model InvoiceComment {
  id          String   @id @default(cuid())
  invoiceId   String
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  userId      String
  userName    String   // Nombre del usuario que creó el comentario
  
  comment     String   // Contenido del comentario
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([invoiceId])
  @@index([createdAt])
}

model Attendance {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  projectId   String?
  project     Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  
  taskId      String?
  task        Task?    @relation(fields: [taskId], references: [id], onDelete: SetNull)
  
  date        DateTime @default(now())
  checkIn     DateTime @default(now())
  checkOut    DateTime?
  
  // Snapshot del coste/hora en el momento del registro
  hourlyRate  Decimal? @db.Decimal(10, 2)
  
  notes       String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([userId])
  @@index([companyId])
  @@index([projectId])
  @@index([taskId])
  @@index([date])
}

model Backup {
  id          String   @id @default(cuid())
  name        String   // Nombre descriptivo del respaldo
  data        String   @db.Text // JSON del respaldo
  size        Int      // Tamaño en bytes
  createdBy   String   // ID del usuario que creó el respaldo
  createdAt   DateTime @default(now())
  
  @@index([createdAt])
}

model Project {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  name        String
  description String?  @db.Text
  status      ProjectStatus @default(ACTIVE)
  
  startDate   DateTime?
  endDate     DateTime?
  
  // Facturación del proyecto
  productId   String?   // Producto/Servicio asociado para facturación
  product     Product?  @relation(fields: [productId], references: [id], onDelete: SetNull)
  salePrice   Decimal?  @db.Decimal(10, 2) // Precio de venta del proyecto
  
  color       String?  @default("#10b981") // Color para identificación visual
  
  active      Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  tasks       Task[]
  attendances Attendance[]
  invoiceItems InvoiceItem[]
  quoteItems   QuoteItem[]
  staff       ProjectStaff[] // Personal asignado al proyecto
  expenses    ProjectExpense[] // Gastos del proyecto
  properties  Property[] // Propiedades asociadas al proyecto
  
  @@index([userId])
  @@index([companyId])
  @@index([status])
  @@index([productId])
}

// Personal asignado a proyectos con su coste
model ProjectStaff {
  id          String   @id @default(cuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  hourlyRate  Decimal  @db.Decimal(10, 2) // Coste por hora de este usuario en este proyecto
  role        String?  // Rol en el proyecto (ej: "Desarrollador", "Gerente de Proyecto")
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([projectId, userId]) // Un usuario solo puede estar asignado una vez por proyecto
  @@index([projectId])
  @@index([userId])
}

// Gastos de proyectos (materiales, equipos, mano de obra)
model ProjectExpense {
  id          String   @id @default(cuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  type        ExpenseType // Tipo de gasto: MATERIAL, EQUIPMENT, LABOR
  description String   // Descripción del gasto
  quantity    Decimal  @db.Decimal(10, 2) // Cantidad
  unitPrice   Decimal  @db.Decimal(10, 2) // Precio unitario
  totalPrice  Decimal  @db.Decimal(10, 2) // Precio total (quantity * unitPrice)
  
  date        DateTime @default(now()) // Fecha del gasto
  notes       String?  @db.Text
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([projectId])
  @@index([type])
}

enum ExpenseType {
  MATERIAL    // Gastos de materiales
  EQUIPMENT   // Gastos de equipos
  LABOR       // Gastos de mano de obra
}

enum ProjectStatus {
  ACTIVE      // Activo
  COMPLETED   // Completado
  ARCHIVED    // Archivado
}

model Task {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation("TaskCreator", fields: [userId], references: [id], onDelete: Cascade)
  
  assignedToId String?
  assignedTo   User?   @relation("TaskAssignee", fields: [assignedToId], references: [id], onDelete: SetNull)
  
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  title       String
  description String?  @db.Text
  completed   Boolean  @default(false)
  
  priority    TaskPriority @default(MEDIUM)
  
  estimatedHours Decimal? @db.Decimal(10, 2) // Horas estimadas para completar la tarea
  cost        Decimal? @db.Decimal(10, 2) // Coste asociado a la tarea
  
  dueDate     DateTime?
  completedAt DateTime?
  
  order       Int      @default(0) // Para ordenar tareas
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  attendances Attendance[]
  
  @@index([userId])
  @@index([projectId])
  @@index([assignedToId])
  @@index([completed])
}

enum TaskPriority {
  LOW         // Baja
  MEDIUM      // Media
  HIGH        // Alta
  URGENT      // Urgente
}

model WebContact {
  id          String   @id @default(cuid())
  name        String
  email       String
  phone       String?
  company     String?
  message     String   @db.Text
  status      WebContactStatus @default(PENDING)
  notes       String?  @db.Text
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([status])
  @@index([createdAt])
}

enum WebContactStatus {
  PENDING     // Pendiente
  CONTACTED   // Contactado
  CLOSED      // Cerrado
}

// Modelos CRM
model CrmPipeline {
  id          String   @id @default(cuid())
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  name        String   // Nombre del pipeline (ej: "Ventas", "Proyectos")
  description String?  @db.Text
  isDefault   Boolean  @default(false)
  order       Int      @default(0)
  
  publicFormToken String? @unique // Token único para formulario público de oportunidades
  publicFormEnabled Boolean @default(false) // Si el formulario público está habilitado
  
  stages      CrmStage[]
  opportunities CrmOpportunity[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([companyId])
}

model CrmStage {
  id          String   @id @default(cuid())
  pipelineId  String
  pipeline    CrmPipeline @relation(fields: [pipelineId], references: [id], onDelete: Cascade)
  
  name        String   // Nombre de la etapa (ej: "Prospecto", "Negociación", "Cerrado")
  color       String   @default("#3b82f6") // Color de la etapa
  order       Int      @default(0) // Orden de la etapa en el pipeline
  
  opportunities CrmOpportunity[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([pipelineId])
}

model CrmOpportunity {
  id          String   @id @default(cuid())
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  pipelineId  String
  pipeline    CrmPipeline @relation(fields: [pipelineId], references: [id], onDelete: Cascade)
  
  stageId     String
  stage       CrmStage @relation(fields: [stageId], references: [id], onDelete: Restrict)
  
  contactId   String?
  contact     Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)
  
  title       String   // Título de la oportunidad
  description String?  @db.Text
  value       Float    @default(0) // Valor estimado de la oportunidad
  currency    String   @default("EUR")
  probability Int      @default(50) // Probabilidad de cierre (0-100)
  
  expectedCloseDate DateTime?
  closedDate        DateTime?
  
  priority    OpportunityPriority @default(MEDIUM)
  status      OpportunityStatus   @default(OPEN)
  
  tags        String[] // Tags para categorizar (ej: ["urgente", "grande"])
  
  scheduledDate DateTime? // Fecha programada para seguimiento en calendario
  
  order       Int      @default(0) // Orden dentro de la etapa
  
  notes       String?  @db.Text
  
  activities  CrmActivity[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([companyId])
  @@index([pipelineId])
  @@index([stageId])
  @@index([contactId])
  @@index([status])
}

enum OpportunityPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum OpportunityStatus {
  OPEN        // Abierta
  WON         // Ganada
  LOST        // Perdida
}

model CrmActivity {
  id            String   @id @default(cuid())
  opportunityId String
  opportunity   CrmOpportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  
  type          ActivityType
  title         String
  description   String?  @db.Text
  dueDate       DateTime?
  completed     Boolean  @default(false)
  completedAt   DateTime?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([opportunityId])
  @@index([completed])
}

enum ActivityType {
  CALL        // Llamada
  EMAIL       // Email
  MEETING     // Reunión
  TASK        // Tarea
  NOTE        // Nota
}

model Tracking {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  contactId   String?
  contact     Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)
  
  productId   String?
  product     Product? @relation(fields: [productId], references: [id], onDelete: SetNull)
  
  invoiceId   String?
  invoice     Invoice? @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  
  trackingNumber String  // Número de seguimiento único
  description    String  @db.Text
  status         TrackingStatus @default(REQUESTED)
  publicToken    String? @unique @default(cuid()) // Token único para acceso público
  
  origin         String?  // Origen del envío
  destination    String?  // Destino del envío
  
  carrier        String?  // Transportista (DHL, FedEx, etc.)
  weight         Float?   // Peso del paquete
  
  requestedDate  DateTime @default(now())
  receivedDate   DateTime?
  paidDate       DateTime?
  shippedDate    DateTime?
  inTransitDate  DateTime?
  deliveredDate  DateTime?
  
  notes          String?  @db.Text
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([userId])
  @@index([companyId])
  @@index([contactId])
  @@index([productId])
  @@index([invoiceId])
  @@index([status])
  @@index([trackingNumber])
}

enum TrackingStatus {
  REQUESTED       // Solicitado
  RECEIVED        // Recibido en Oficina
  PAID            // Pagado
  SHIPPED         // Enviado
  IN_TRANSIT      // En Tránsito
  DELIVERED       // Llegó
}

// Modelo de Equipos
model Equipment {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  code        String   // Código del equipo
  name        String   // Nombre del equipo
  
  ownerId     String?  // Propietario (contacto)
  owner       Contact? @relation(fields: [ownerId], references: [id], onDelete: SetNull)
  
  licensePlate String? // Matrícula
  kilometers   Float?  @default(0) // Kilómetros
  hours        Float?  @default(0) // Horas
  
  active      Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([companyId, code])
  @@index([userId])
  @@index([companyId])
  @@index([ownerId])
}

// Modelo de Órdenes de Trabajo
model WorkOrder {
  id                String   @id @default(cuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  companyId         String
  company           Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  number            String   // Número de la orden (ej: OT-2024-001)
  date              DateTime @default(now())
  scheduledDate     DateTime // Fecha programada con hora
  
  approvedByClient  Boolean  @default(false) // Aprobado por cliente
  
  responsibleId     String   // Responsable (usuario)
  responsible       User     @relation("WorkOrderResponsible", fields: [responsibleId], references: [id])
  
  notes             String?  @db.Text
  publicToken       String?  @unique // Token para enlace público
  active            Boolean  @default(true)
  
  // Relación con cotización origen
  quote             Quote?   @relation("QuoteToWorkOrder")
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  items             WorkOrderItem[]
  
  @@unique([companyId, number])
  @@index([userId])
  @@index([companyId])
  @@index([responsibleId])
  @@index([publicToken])
  @@index([date])
}

model WorkOrderItem {
  id            String     @id @default(cuid())
  workOrderId   String
  workOrder     WorkOrder  @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  
  productId     String
  product       Product    @relation(fields: [productId], references: [id])
  
  description   String
  quantity      Float
  durationHours Float      @default(1) // Duración estimada en horas
  status        WorkOrderItemStatus @default(PENDING) // Estado de la línea
  
  startedAt     DateTime?  // Fecha/hora de inicio
  completedAt   DateTime?  // Fecha/hora de finalización
  
  createdAt     DateTime   @default(now())
  
  @@index([workOrderId])
  @@index([productId])
  @@index([status])
}

enum WorkOrderItemStatus {
  PENDING     // Pendiente
  IN_PROGRESS // En proceso
  COMPLETED   // Completado
}

// Modelo de Propiedades
model Property {
  id                    String   @id @default(cuid())
  userId                String
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  companyId             String
  company               Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  code                  String   // Código de la propiedad
  address               String   // Dirección
  block                 String?  // Bloque
  number                String?  // Número
  
  projectId             String?
  project               Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  
  constructionDate      DateTime? // Fecha de construcción
  contractAmount        Decimal?  @db.Decimal(15, 2) // Importe de contrato
  contractStartDate     DateTime? // Fecha de inicio de contrato
  contractEndDate       DateTime? // Fecha fin de contrato
  
  notes                 String?  @db.Text
  active                Boolean  @default(true)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  contacts              PropertyContact[]
  
  @@unique([companyId, code])
  @@index([userId])
  @@index([companyId])
  @@index([projectId])
}

model PropertyContact {
  id             String   @id @default(cuid())
  propertyId     String
  property       Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  contactId      String
  contact        Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  
  responsibility String   // Responsabilidad (ej: "Presidente Bloque A")
  
  createdAt      DateTime @default(now())
  
  @@index([propertyId])
  @@index([contactId])
}
